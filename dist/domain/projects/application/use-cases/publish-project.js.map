{"version":3,"sources":["../../../../../src/domain/projects/application/use-cases/publish-project.ts"],"sourcesContent":["import type { UsersRepository } from '@/domain/authentication/application/repositories/users-repository'\nimport { Project } from '@/domain/projects/enterprise/entities/project'\nimport type { Subject } from '@/domain/projects/enterprise/entities/subject'\nimport { ProjectStatus } from '@/domain/projects/enterprise/value-objects/project-status'\nimport { type Either, left, right } from '@/shared/either'\nimport { ForbiddenError } from '@/shared/errors/forbidden.error'\nimport { ResourceNotFoundError } from '@/shared/errors/resource-not-found.error'\nimport type { ProfessorsRepository } from '../repositories/professors-repository'\nimport type { ProjectsRepository } from '../repositories/projects-repository'\nimport type { SubjectsRepository } from '../repositories/subjects-repository'\nimport type { TrailsRepository } from '../repositories/trails-repository'\n\ninterface PublishProjectUseCaseRequest {\n  title: string\n  description: string\n  bannerUrl?: string\n  content?: string\n  publishedYear: number\n  semester: number\n  allowComments: boolean\n  authorId: string\n  subjectId?: string\n  trailsIds: string[]\n  professorsIds?: string[]\n  draftId?: string\n}\n\ntype PublishProjectUseCaseResponse = Either<\n  ForbiddenError | ResourceNotFoundError,\n  {\n    projectId: string\n  }\n>\n\nexport class PublishProjectUseCase {\n  constructor(\n    private readonly projectsRepository: ProjectsRepository,\n    private readonly studentsRepository: UsersRepository,\n    private readonly subjectsRepository: SubjectsRepository,\n    private readonly trailsRepository: TrailsRepository,\n    private readonly professorsRepository: ProfessorsRepository,\n  ) {}\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: This logic will be refactored soon.\n  async execute({\n    title,\n    description,\n    bannerUrl,\n    content,\n    publishedYear,\n    semester,\n    allowComments,\n    authorId,\n    subjectId,\n    trailsIds,\n    professorsIds,\n    draftId,\n  }: PublishProjectUseCaseRequest): Promise<PublishProjectUseCaseResponse> {\n    if (!authorId) {\n      return left(\n        new ForbiddenError('You must be logged in to publish a project.'),\n      )\n    }\n\n    const student = await this.studentsRepository.findById(authorId)\n\n    if (!student) {\n      return left(new ResourceNotFoundError('Student not found.'))\n    }\n\n    let subject: Subject | null = null\n\n    if (subjectId) {\n      subject = await this.subjectsRepository.findById(subjectId)\n\n      if (!subject) {\n        return left(new ResourceNotFoundError('Subject not found.'))\n      }\n    }\n\n    const trails = await Promise.all(\n      trailsIds.map(async trailId => {\n        const trail = await this.trailsRepository.findById(trailId)\n\n        return trail\n      }),\n    )\n\n    if (trails.some(trail => !trail)) {\n      return left(new ResourceNotFoundError('Trail not found.'))\n    }\n\n    const professors = await Promise.all(\n      professorsIds\n        ? professorsIds.map(async professorId => {\n            const professor =\n              await this.professorsRepository.findById(professorId)\n\n            return professor\n          })\n        : [],\n    )\n\n    if (professorsIds && professors.some(professor => !professor)) {\n      return left(new ResourceNotFoundError('Professor not found.'))\n    }\n\n    let createdProjectId = ''\n\n    if (draftId) {\n      const draft = await this.projectsRepository.findById(draftId)\n\n      if (!draft) {\n        return left(new ResourceNotFoundError('Draft not found.'))\n      }\n\n      if (draft.authorId.toString() !== authorId) {\n        return left(\n          new ForbiddenError('You are not allowed to publish this draft.'),\n        )\n      }\n\n      draft.post()\n\n      draft.editInfo({\n        title,\n        description,\n        bannerUrl,\n        content,\n        publishedYear,\n        semester,\n        allowComments,\n        subjectId: subject ? subject.id : undefined,\n      })\n\n      if (trails.length > 0) {\n        draft.defineTrails(\n          trails.filter(trail => trail !== null).map(trail => trail.id),\n        )\n      }\n\n      if (professors.length > 0) {\n        draft.defineProfessors(\n          professors\n            .filter(professor => professor !== null)\n            .map(professor => professor.id),\n        )\n      }\n\n      await this.projectsRepository.save(draft)\n\n      createdProjectId = draft.id.toString()\n    } else {\n      const project = Project.create({\n        title,\n        description,\n        bannerUrl,\n        content: content || '',\n        publishedYear,\n        semester,\n        allowComments,\n        status: ProjectStatus.PUBLISHED,\n        authorId: student.id,\n        subjectId: subject ? subject.id : undefined,\n        trails: new Set(\n          trails.filter(trail => trail !== null).map(trail => trail.id),\n        ),\n        professors: new Set(\n          professors\n            .filter(professor => professor !== null)\n            .map(professor => professor.id),\n        ),\n      })\n\n      await this.projectsRepository.create(project)\n      createdProjectId = project.id.toString()\n    }\n\n    return right({\n      projectId: createdProjectId,\n    })\n  }\n}\n"],"names":["PublishProjectUseCase","execute","title","description","bannerUrl","content","publishedYear","semester","allowComments","authorId","subjectId","trailsIds","professorsIds","draftId","left","ForbiddenError","student","studentsRepository","findById","ResourceNotFoundError","subject","subjectsRepository","trails","Promise","all","map","trailId","trail","trailsRepository","some","professors","professorId","professor","professorsRepository","createdProjectId","draft","projectsRepository","toString","post","editInfo","id","undefined","length","defineTrails","filter","defineProfessors","save","project","Project","create","status","ProjectStatus","PUBLISHED","Set","right","projectId"],"mappings":"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"}