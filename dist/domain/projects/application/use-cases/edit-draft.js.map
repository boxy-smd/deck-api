{"version":3,"sources":["../../../../../src/domain/projects/application/use-cases/edit-draft.ts"],"sourcesContent":["import type { UsersRepository } from '@/domain/authentication/application/repositories/users-repository'\nimport type { ProjectsRepository } from '@/domain/projects/application/repositories/projects-repository'\nimport type { Project } from '@/domain/projects/enterprise/entities/project'\nimport { type Either, left, right } from '@/shared/either'\nimport { ForbiddenError } from '@/shared/errors/forbidden.error'\nimport { ResourceNotFoundError } from '@/shared/errors/resource-not-found.error'\nimport type { ProfessorsRepository } from '../../../projects/application/repositories/professors-repository'\nimport type { SubjectsRepository } from '../../../projects/application/repositories/subjects-repository'\nimport type { TrailsRepository } from '../../../projects/application/repositories/trails-repository'\n\ninterface EditDraftUseCaseRequest {\n  authorId: string\n  draftId: string\n  title?: string\n  description?: string\n  bannerUrl?: string\n  content?: string\n  publishedYear?: number\n  semester?: number\n  allowComments?: boolean\n  subjectId?: string\n  trailsIds?: string[]\n  professorsIds?: string[]\n}\n\ntype EditDraftUseCaseResponse = Either<\n  ForbiddenError | ResourceNotFoundError,\n  Project\n>\n\nexport class EditDraftUseCase {\n  constructor(\n    private readonly projectsRepository: ProjectsRepository,\n    private readonly studentsRepository: UsersRepository,\n    private readonly subjectsRepository: SubjectsRepository,\n    private readonly trailsRepository: TrailsRepository,\n    private readonly professorsRepository: ProfessorsRepository,\n  ) {}\n\n  async execute({\n    authorId,\n    draftId,\n    title,\n    description,\n    bannerUrl,\n    content,\n    publishedYear,\n    semester,\n    allowComments,\n    subjectId,\n    trailsIds,\n    professorsIds,\n  }: EditDraftUseCaseRequest): Promise<EditDraftUseCaseResponse> {\n    if (!authorId) {\n      return left(new ForbiddenError('You must be logged in to edit a draft.'))\n    }\n\n    const student = await this.studentsRepository.findById(authorId)\n\n    if (!student) {\n      return left(new ResourceNotFoundError('Student not found.'))\n    }\n\n    const draft = await this.projectsRepository.findById(draftId)\n\n    if (!draft) {\n      return left(new ResourceNotFoundError('Draft not found.'))\n    }\n\n    if (draft.authorId.toString() !== authorId) {\n      return left(new ForbiddenError('You are not allowed to edit this draft.'))\n    }\n\n    draft.editInfo({\n      title,\n      description,\n      bannerUrl,\n      content,\n      publishedYear,\n      semester,\n      allowComments,\n    })\n\n    if (subjectId) {\n      const subject = await this.subjectsRepository.findById(subjectId)\n\n      if (!subject) {\n        return left(new ResourceNotFoundError('Subject not found.'))\n      }\n\n      draft.editInfo({ subjectId: subject.id })\n    }\n\n    const trails = await Promise.all(\n      trailsIds\n        ? trailsIds.map(async trailId => {\n            const trail = await this.trailsRepository.findById(trailId)\n\n            return trail\n          })\n        : [],\n    )\n\n    if (trails.some(trail => !trail)) {\n      return left(new ResourceNotFoundError('Some trails were not found.'))\n    }\n\n    draft.defineTrails(\n      trails.filter(trail => trail !== null).map(trail => trail.id),\n    )\n\n    const professors = await Promise.all(\n      professorsIds\n        ? professorsIds.map(async professorId => {\n            const professor =\n              await this.professorsRepository.findById(professorId)\n\n            return professor\n          })\n        : [],\n    )\n\n    if (professors.some(professor => !professor)) {\n      return left(new ResourceNotFoundError('Some professors were not found.'))\n    }\n\n    draft.defineProfessors(\n      professors\n        .filter(professor => professor !== null)\n        .map(professor => professor.id),\n    )\n\n    await this.projectsRepository.save(draft)\n\n    return right(draft)\n  }\n}\n"],"names":["EditDraftUseCase","execute","authorId","draftId","title","description","bannerUrl","content","publishedYear","semester","allowComments","subjectId","trailsIds","professorsIds","left","ForbiddenError","student","studentsRepository","findById","ResourceNotFoundError","draft","projectsRepository","toString","editInfo","subject","subjectsRepository","id","trails","Promise","all","map","trailId","trail","trailsRepository","some","defineTrails","filter","professors","professorId","professor","professorsRepository","defineProfessors","save","right"],"mappings":";;;;+BA8BaA;;;eAAAA;;;wBA3B4B;gCACV;uCACO;AAyB/B,IAAA,AAAMA,mBAAN,MAAMA;IASX,MAAMC,QAAQ,EACZC,QAAQ,EACRC,OAAO,EACPC,KAAK,EACLC,WAAW,EACXC,SAAS,EACTC,OAAO,EACPC,aAAa,EACbC,QAAQ,EACRC,aAAa,EACbC,SAAS,EACTC,SAAS,EACTC,aAAa,EACW,EAAqC;QAC7D,IAAI,CAACX,UAAU;YACb,OAAOY,IAAAA,YAAI,EAAC,IAAIC,8BAAc,CAAC;QACjC;QAEA,MAAMC,UAAU,MAAM,IAAI,CAACC,kBAAkB,CAACC,QAAQ,CAAChB;QAEvD,IAAI,CAACc,SAAS;YACZ,OAAOF,IAAAA,YAAI,EAAC,IAAIK,4CAAqB,CAAC;QACxC;QAEA,MAAMC,QAAQ,MAAM,IAAI,CAACC,kBAAkB,CAACH,QAAQ,CAACf;QAErD,IAAI,CAACiB,OAAO;YACV,OAAON,IAAAA,YAAI,EAAC,IAAIK,4CAAqB,CAAC;QACxC;QAEA,IAAIC,MAAMlB,QAAQ,CAACoB,QAAQ,OAAOpB,UAAU;YAC1C,OAAOY,IAAAA,YAAI,EAAC,IAAIC,8BAAc,CAAC;QACjC;QAEAK,MAAMG,QAAQ,CAAC;YACbnB;YACAC;YACAC;YACAC;YACAC;YACAC;YACAC;QACF;QAEA,IAAIC,WAAW;YACb,MAAMa,UAAU,MAAM,IAAI,CAACC,kBAAkB,CAACP,QAAQ,CAACP;YAEvD,IAAI,CAACa,SAAS;gBACZ,OAAOV,IAAAA,YAAI,EAAC,IAAIK,4CAAqB,CAAC;YACxC;YAEAC,MAAMG,QAAQ,CAAC;gBAAEZ,WAAWa,QAAQE,EAAE;YAAC;QACzC;QAEA,MAAMC,SAAS,MAAMC,QAAQC,GAAG,CAC9BjB,YACIA,UAAUkB,GAAG,CAAC,OAAMC;YAClB,MAAMC,QAAQ,MAAM,IAAI,CAACC,gBAAgB,CAACf,QAAQ,CAACa;YAEnD,OAAOC;QACT,KACA,EAAE;QAGR,IAAIL,OAAOO,IAAI,CAACF,CAAAA,QAAS,CAACA,QAAQ;YAChC,OAAOlB,IAAAA,YAAI,EAAC,IAAIK,4CAAqB,CAAC;QACxC;QAEAC,MAAMe,YAAY,CAChBR,OAAOS,MAAM,CAACJ,CAAAA,QAASA,UAAU,MAAMF,GAAG,CAACE,CAAAA,QAASA,MAAMN,EAAE;QAG9D,MAAMW,aAAa,MAAMT,QAAQC,GAAG,CAClChB,gBACIA,cAAciB,GAAG,CAAC,OAAMQ;YACtB,MAAMC,YACJ,MAAM,IAAI,CAACC,oBAAoB,CAACtB,QAAQ,CAACoB;YAE3C,OAAOC;QACT,KACA,EAAE;QAGR,IAAIF,WAAWH,IAAI,CAACK,CAAAA,YAAa,CAACA,YAAY;YAC5C,OAAOzB,IAAAA,YAAI,EAAC,IAAIK,4CAAqB,CAAC;QACxC;QAEAC,MAAMqB,gBAAgB,CACpBJ,WACGD,MAAM,CAACG,CAAAA,YAAaA,cAAc,MAClCT,GAAG,CAACS,CAAAA,YAAaA,UAAUb,EAAE;QAGlC,MAAM,IAAI,CAACL,kBAAkB,CAACqB,IAAI,CAACtB;QAEnC,OAAOuB,IAAAA,aAAK,EAACvB;IACf;IAxGA,YACE,AAAiBC,kBAAsC,EACvD,AAAiBJ,kBAAmC,EACpD,AAAiBQ,kBAAsC,EACvD,AAAiBQ,gBAAkC,EACnD,AAAiBO,oBAA0C,CAC3D;aALiBnB,qBAAAA;aACAJ,qBAAAA;aACAQ,qBAAAA;aACAQ,mBAAAA;aACAO,uBAAAA;IAChB;AAmGL"}