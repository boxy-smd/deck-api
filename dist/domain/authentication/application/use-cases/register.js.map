{"version":3,"sources":["../../../../../src/domain/authentication/application/use-cases/register.ts"],"sourcesContent":["import type { TrailsRepository } from '@/domain/projects/application/repositories/trails-repository'\nimport { type Either, left, right } from '@/shared/either'\nimport { ResourceAlreadyExistsError } from '@/shared/errors/resource-already-exists.error'\nimport { ResourceNotFoundError } from '@/shared/errors/resource-not-found.error'\nimport { User } from '../../enterprise/entities/user'\nimport { Email } from '../../enterprise/value-objects/email'\nimport { UserRole } from '../../enterprise/value-objects/user-role'\nimport { UserStatus } from '../../enterprise/value-objects/user-status'\nimport { Username } from '../../enterprise/value-objects/username'\nimport type { HashGenerator } from '../cryptography/hash-generator'\nimport { EmailBadFormattedError } from '../errors/email-bad-formatted.error'\nimport type { SemesterOutOfBoundsError } from '../errors/semester-out-of-bounds.error'\nimport type { UsernameBadFormattedError } from '../errors/username-bad-formatted.error'\nimport type { UsernameInvalidSizeError } from '../errors/username-invalid-size.error'\nimport type { UsersRepository } from '../repositories/users-repository'\n\ninterface RegisterUseCaseRequest {\n  name: string\n  username: string\n  email: string\n  password: string\n  semester: number\n  trailsIds: string[]\n  about?: string\n  profileUrl?: string\n}\n\ntype RegisterUseCaseResponse = Either<\n  | ResourceNotFoundError\n  | ResourceAlreadyExistsError\n  | EmailBadFormattedError\n  | UsernameBadFormattedError\n  | UsernameInvalidSizeError\n  | SemesterOutOfBoundsError,\n  User\n>\n\nexport class RegisterUseCase {\n  constructor(\n    private usersRepository: UsersRepository,\n    private trailsRepository: TrailsRepository,\n    private hasher: HashGenerator,\n  ) {}\n\n  public async execute(\n    request: RegisterUseCaseRequest,\n  ): Promise<RegisterUseCaseResponse> {\n    const isUsernameTaken = await this.usersRepository.findByUsername(\n      request.username,\n    )\n\n    if (isUsernameTaken) {\n      return left(\n        new ResourceAlreadyExistsError('O nome de usuário já está em uso'),\n      )\n    }\n\n    const isEmailTaken = await this.usersRepository.findByEmail(request.email)\n\n    if (isEmailTaken) {\n      return left(new ResourceAlreadyExistsError('Este e-mail já está em uso'))\n    }\n\n    const passwordHash = await this.hasher.hash(request.password)\n\n    let validatedEmail: Email\n\n    try {\n      validatedEmail = Email.create(request.email)\n    } catch (error) {\n      if (error instanceof EmailBadFormattedError) {\n        return left(error)\n      }\n\n      return left(new EmailBadFormattedError())\n    }\n\n    const validatedUsername = Username.create(request.username)\n\n    if (validatedUsername.isLeft()) {\n      return left(validatedUsername.value)\n    }\n\n    const username = validatedUsername.value\n\n    const user = User.create({\n      name: request.name,\n      username,\n      email: validatedEmail,\n      passwordHash,\n      about: request.about,\n      profileUrl: request.profileUrl,\n      role: UserRole.STUDENT,\n      status: UserStatus.ACTIVE,\n    })\n\n    user.createProfile(request.semester)\n\n    for (const trailId of request.trailsIds) {\n      const trail = await this.trailsRepository.findById(trailId)\n\n      if (!trail) {\n        return left(new ResourceNotFoundError('Trilha não encontrada'))\n      }\n\n      user.addTrailToProfile(trail.id)\n    }\n\n    await this.usersRepository.create(user)\n\n    return right(user)\n  }\n}\n"],"names":["RegisterUseCase","execute","request","isUsernameTaken","usersRepository","findByUsername","username","left","ResourceAlreadyExistsError","isEmailTaken","findByEmail","email","passwordHash","hasher","hash","password","validatedEmail","Email","create","error","EmailBadFormattedError","validatedUsername","Username","isLeft","value","user","User","name","about","profileUrl","role","UserRole","STUDENT","status","UserStatus","ACTIVE","createProfile","semester","trailId","trailsIds","trail","trailsRepository","findById","ResourceNotFoundError","addTrailToProfile","id","right"],"mappings":";;;;+BAqCaA;;;eAAAA;;;wBApC4B;4CACE;uCACL;sBACjB;uBACC;0BACG;4BACE;0BACF;wCAEc;AA2BhC,IAAA,AAAMA,kBAAN,MAAMA;IAOX,MAAaC,QACXC,OAA+B,EACG;QAClC,MAAMC,kBAAkB,MAAM,IAAI,CAACC,eAAe,CAACC,cAAc,CAC/DH,QAAQI,QAAQ;QAGlB,IAAIH,iBAAiB;YACnB,OAAOI,IAAAA,YAAI,EACT,IAAIC,sDAA0B,CAAC;QAEnC;QAEA,MAAMC,eAAe,MAAM,IAAI,CAACL,eAAe,CAACM,WAAW,CAACR,QAAQS,KAAK;QAEzE,IAAIF,cAAc;YAChB,OAAOF,IAAAA,YAAI,EAAC,IAAIC,sDAA0B,CAAC;QAC7C;QAEA,MAAMI,eAAe,MAAM,IAAI,CAACC,MAAM,CAACC,IAAI,CAACZ,QAAQa,QAAQ;QAE5D,IAAIC;QAEJ,IAAI;YACFA,iBAAiBC,YAAK,CAACC,MAAM,CAAChB,QAAQS,KAAK;QAC7C,EAAE,OAAOQ,OAAO;YACd,IAAIA,iBAAiBC,8CAAsB,EAAE;gBAC3C,OAAOb,IAAAA,YAAI,EAACY;YACd;YAEA,OAAOZ,IAAAA,YAAI,EAAC,IAAIa,8CAAsB;QACxC;QAEA,MAAMC,oBAAoBC,kBAAQ,CAACJ,MAAM,CAAChB,QAAQI,QAAQ;QAE1D,IAAIe,kBAAkBE,MAAM,IAAI;YAC9B,OAAOhB,IAAAA,YAAI,EAACc,kBAAkBG,KAAK;QACrC;QAEA,MAAMlB,WAAWe,kBAAkBG,KAAK;QAExC,MAAMC,OAAOC,UAAI,CAACR,MAAM,CAAC;YACvBS,MAAMzB,QAAQyB,IAAI;YAClBrB;YACAK,OAAOK;YACPJ;YACAgB,OAAO1B,QAAQ0B,KAAK;YACpBC,YAAY3B,QAAQ2B,UAAU;YAC9BC,MAAMC,kBAAQ,CAACC,OAAO;YACtBC,QAAQC,sBAAU,CAACC,MAAM;QAC3B;QAEAV,KAAKW,aAAa,CAAClC,QAAQmC,QAAQ;QAEnC,KAAK,MAAMC,WAAWpC,QAAQqC,SAAS,CAAE;YACvC,MAAMC,QAAQ,MAAM,IAAI,CAACC,gBAAgB,CAACC,QAAQ,CAACJ;YAEnD,IAAI,CAACE,OAAO;gBACV,OAAOjC,IAAAA,YAAI,EAAC,IAAIoC,4CAAqB,CAAC;YACxC;YAEAlB,KAAKmB,iBAAiB,CAACJ,MAAMK,EAAE;QACjC;QAEA,MAAM,IAAI,CAACzC,eAAe,CAACc,MAAM,CAACO;QAElC,OAAOqB,IAAAA,aAAK,EAACrB;IACf;IAzEA,YACE,AAAQrB,eAAgC,EACxC,AAAQqC,gBAAkC,EAC1C,AAAQ5B,MAAqB,CAC7B;aAHQT,kBAAAA;aACAqC,mBAAAA;aACA5B,SAAAA;IACP;AAsEL"}