{"version":3,"sources":["../../../../../src/@presentation/modules/students/controllers/students.controller.ts"],"sourcesContent":["import { makeEditProfileUseCase } from '@/@core/application/factories/students/make-edit-profile-use-case'\nimport { makeFetchStudentsUseCase } from '@/@core/application/factories/students/make-fetch-students-use-case'\nimport { makeGetProfileUseCase } from '@/@core/application/factories/students/make-get-profile-use-case'\nimport { makeGetStudentDetailsUseCase } from '@/@core/application/factories/students/make-get-student-details-use-case'\nimport { makeLoginUseCase } from '@/@core/application/factories/students/make-login-use-case'\nimport { makeRegisterUseCase } from '@/@core/application/factories/students/make-register-use-case'\nimport { makeUploadProfileImageUseCase } from '@/@core/application/factories/students/make-upload-profile-image-use-case'\nimport { JwtAuthGuard } from '@/@presentation/modules/auth/guards/jwt-auth.guard'\nimport { StudentPresenter } from '@/@presentation/presenters/student'\nimport { StudentProfilePresenter } from '@/@presentation/presenters/student-profile'\nimport {\n  BadRequestException,\n  Body,\n  ConflictException,\n  Controller,\n  ForbiddenException,\n  Get,\n  HttpCode,\n  HttpStatus,\n  NotFoundException,\n  Param,\n  Patch,\n  Post,\n  Put,\n  Query,\n  Request,\n  UnauthorizedException,\n  UploadedFile,\n  UseGuards,\n  UseInterceptors,\n} from '@nestjs/common'\nimport type { JwtService } from '@nestjs/jwt'\nimport { FileInterceptor } from '@nestjs/platform-express'\nimport {\n  ApiBearerAuth,\n  ApiBody,\n  ApiConsumes,\n  ApiOperation,\n  ApiResponse,\n  ApiTags,\n} from '@nestjs/swagger'\nimport type { EditProfileDto } from '../dto/edit-profile.dto'\nimport type { FetchStudentsDto } from '../dto/fetch-students.dto'\nimport type { LoginStudentDto } from '../dto/login-student.dto'\nimport type { RegisterStudentDto } from '../dto/register-student.dto'\n\n@ApiTags('Students')\n@Controller()\nexport class StudentsController {\n  constructor(private jwtService: JwtService) {}\n\n  @Post('students')\n  @ApiOperation({ summary: 'Register a new student' })\n  @ApiResponse({ status: 201, description: 'Student registered successfully' })\n  @ApiResponse({ status: 400, description: 'Bad request' })\n  @ApiResponse({ status: 409, description: 'Student already exists' })\n  async register(@Body() registerDto: RegisterStudentDto) {\n    const registerUseCase = makeRegisterUseCase()\n\n    const result = await registerUseCase.execute({\n      name: registerDto.name,\n      username: registerDto.username,\n      email: registerDto.email,\n      password: registerDto.password,\n      semester: registerDto.semester,\n      about: registerDto.about,\n      profileUrl: registerDto.profileUrl,\n      trailsIds: registerDto.trailsIds,\n    })\n\n    if (result.isLeft()) {\n      const error = result.value\n      if (error.statusCode === 409) {\n        throw new ConflictException(error.message)\n      }\n      throw new BadRequestException(error.message)\n    }\n\n    return { user_id: result.value.id.toString() }\n  }\n\n  @Post('sessions')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Login student' })\n  @ApiResponse({ status: 200, description: 'Login successful' })\n  @ApiResponse({ status: 401, description: 'Invalid credentials' })\n  async login(@Body() loginDto: LoginStudentDto) {\n    const loginUseCase = makeLoginUseCase()\n\n    const result = await loginUseCase.execute({\n      email: loginDto.email,\n      password: loginDto.password,\n    })\n\n    if (result.isLeft()) {\n      const error = result.value\n      throw new UnauthorizedException(error.message)\n    }\n\n    const token = this.jwtService.sign({\n      sub: result.value.id,\n      role: 'student',\n    })\n\n    return { token }\n  }\n\n  @Get('profiles/:username')\n  @ApiOperation({ summary: 'Get student profile by username' })\n  @ApiResponse({ status: 200, description: 'Profile retrieved successfully' })\n  @ApiResponse({ status: 404, description: 'Student not found' })\n  async getProfile(@Param('username') username: string) {\n    const getProfileUseCase = makeGetProfileUseCase()\n\n    const result = await getProfileUseCase.execute({ username })\n\n    if (result.isLeft()) {\n      const error = result.value\n      if (error.statusCode === 404) {\n        throw new NotFoundException(error.message)\n      }\n      throw new BadRequestException(error.message)\n    }\n\n    return StudentProfilePresenter.toHTTP(result.value)\n  }\n\n  @Put('profiles/:studentId')\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Edit student profile' })\n  @ApiResponse({ status: 200, description: 'Profile updated successfully' })\n  @ApiResponse({ status: 403, description: 'Forbidden' })\n  @ApiResponse({ status: 404, description: 'Student not found' })\n  async editProfile(\n    @Param('studentId') studentId: string,\n    @Body() editDto: EditProfileDto,\n    @Request() req: any,\n  ) {\n    if (studentId !== req.user.userId) {\n      throw new ForbiddenException('Forbidden.')\n    }\n\n    const editProfileUseCase = makeEditProfileUseCase()\n\n    const result = await editProfileUseCase.execute({\n      studentId,\n      profileUrl: editDto.profileUrl,\n      semester: editDto.semester,\n      trailsIds: editDto.trailsIds,\n      about: editDto.about,\n    })\n\n    if (result.isLeft()) {\n      const error = result.value\n      if (error.statusCode === 404) {\n        throw new NotFoundException(error.message)\n      }\n      throw new BadRequestException(error.message)\n    }\n\n    return {\n      profile: StudentProfilePresenter.toHTTP(result.value),\n    }\n  }\n\n  @Get('students')\n  @ApiOperation({ summary: 'Fetch students' })\n  @ApiResponse({ status: 200, description: 'Students retrieved successfully' })\n  async fetchStudents(@Query() query: FetchStudentsDto) {\n    const fetchStudentsUseCase = makeFetchStudentsUseCase()\n\n    const result = await fetchStudentsUseCase.execute({\n      name: query.name,\n    })\n\n    return {\n      students: result.map(StudentPresenter.toHTTP),\n    }\n  }\n\n  @Get('students/:studentId')\n  @ApiOperation({ summary: 'Get student details' })\n  @ApiResponse({\n    status: 200,\n    description: 'Student details retrieved successfully',\n  })\n  @ApiResponse({ status: 404, description: 'Student not found' })\n  async getStudentDetails(@Param('studentId') studentId: string) {\n    const getStudentDetailsUseCase = makeGetStudentDetailsUseCase()\n\n    const result = await getStudentDetailsUseCase.execute({\n      username: studentId,\n    })\n\n    if (result.isLeft()) {\n      const error = result.value\n      if (error.statusCode === 404) {\n        throw new NotFoundException(error.message)\n      }\n      throw new BadRequestException(error.message)\n    }\n\n    return StudentProfilePresenter.toHTTP(result.value)\n  }\n\n  @Post('profile-images/:username')\n  @UseGuards(JwtAuthGuard)\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiBearerAuth()\n  @ApiConsumes('multipart/form-data')\n  @ApiOperation({ summary: 'Upload student profile image' })\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        file: {\n          type: 'string',\n          format: 'binary',\n        },\n      },\n    },\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Profile image uploaded successfully',\n  })\n  @ApiResponse({ status: 404, description: 'Student not found' })\n  async uploadProfileImage(\n    @Param('username') username: string,\n    @UploadedFile() file: Express.Multer.File,\n  ) {\n    if (!file) {\n      throw new BadRequestException('File is required')\n    }\n\n    const uploadUseCase = makeUploadProfileImageUseCase()\n\n    const result = await uploadUseCase.execute({\n      username,\n      filename: file.originalname,\n      image: file.buffer,\n    })\n\n    if (result.isLeft()) {\n      const error = result.value\n      if (error.statusCode === 404) {\n        throw new NotFoundException(error.message)\n      }\n      throw new BadRequestException(error.message)\n    }\n\n    return { message: 'Profile image uploaded successfully' }\n  }\n\n  @Patch('token/refresh')\n  @HttpCode(HttpStatus.OK)\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Refresh JWT token' })\n  @ApiResponse({ status: 200, description: 'Token refreshed successfully' })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  async refreshToken(@Request() req: any) {\n    const token = this.jwtService.sign({\n      sub: req.user.userId,\n      role: 'student',\n    })\n\n    return { token }\n  }\n}\n"],"names":["StudentsController","register","registerDto","registerUseCase","makeRegisterUseCase","result","execute","name","username","email","password","semester","about","profileUrl","trailsIds","isLeft","error","value","statusCode","ConflictException","message","BadRequestException","user_id","id","toString","login","loginDto","loginUseCase","makeLoginUseCase","UnauthorizedException","token","jwtService","sign","sub","role","getProfile","getProfileUseCase","makeGetProfileUseCase","NotFoundException","StudentProfilePresenter","toHTTP","editProfile","studentId","editDto","req","user","userId","ForbiddenException","editProfileUseCase","makeEditProfileUseCase","profile","fetchStudents","query","fetchStudentsUseCase","makeFetchStudentsUseCase","students","map","StudentPresenter","getStudentDetails","getStudentDetailsUseCase","makeGetStudentDetailsUseCase","uploadProfileImage","file","uploadUseCase","makeUploadProfileImageUseCase","filename","originalname","image","buffer","refreshToken","summary","status","description","OK","schema","type","properties","format"],"mappings":"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"}