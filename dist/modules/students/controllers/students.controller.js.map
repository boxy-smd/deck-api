{"version":3,"sources":["../../../../src/modules/students/controllers/students.controller.ts"],"sourcesContent":["import { makeEditProfileUseCase } from '@/interface/factories/students/make-edit-profile-use-case'\r\nimport { makeFetchStudentsUseCase } from '@/interface/factories/students/make-fetch-students-use-case'\r\nimport { makeGetProfileUseCase } from '@/interface/factories/students/make-get-profile-use-case'\r\nimport { makeGetStudentDetailsUseCase } from '@/interface/factories/students/make-get-student-details-use-case'\r\nimport { makeLoginUseCase } from '@/interface/factories/students/make-login-use-case'\r\nimport { makeRegisterUseCase } from '@/interface/factories/students/make-register-use-case'\r\nimport { makeUploadProfileImageUseCase } from '@/interface/factories/students/make-upload-profile-image-use-case'\r\nimport { StudentPresenter } from '@/interface/http/presenters/student'\r\nimport { StudentProfilePresenter } from '@/interface/http/presenters/student-profile'\r\nimport { JwtAuthGuard } from '@/modules/auth/guards/jwt-auth.guard'\r\nimport {\r\n  BadRequestException,\r\n  Body,\r\n  ConflictException,\r\n  Controller,\r\n  ForbiddenException,\r\n  Get,\r\n  HttpCode,\r\n  HttpStatus,\r\n  NotFoundException,\r\n  Param,\r\n  Patch,\r\n  Post,\r\n  Put,\r\n  Query,\r\n  Request,\r\n  UnauthorizedException,\r\n  UploadedFile,\r\n  UseGuards,\r\n  UseInterceptors,\r\n} from '@nestjs/common'\r\nimport { JwtService } from '@nestjs/jwt'\r\nimport { FileInterceptor } from '@nestjs/platform-express'\r\nimport {\r\n  ApiBearerAuth,\r\n  ApiBody,\r\n  ApiConsumes,\r\n  ApiOperation,\r\n  ApiResponse,\r\n  ApiTags,\r\n} from '@nestjs/swagger'\r\nimport type { EditProfileDto } from '../dto/edit-profile.dto'\r\nimport type { FetchStudentsDto } from '../dto/fetch-students.dto'\r\nimport type { LoginStudentDto } from '../dto/login-student.dto'\r\nimport type { RegisterStudentDto } from '../dto/register-student.dto'\r\n\r\n@ApiTags('Students')\r\n@Controller()\r\nexport class StudentsController {\r\n  constructor(private jwtService: JwtService) {}\r\n\r\n  @Post('students')\r\n  @ApiOperation({ summary: 'Register a new student' })\r\n  @ApiResponse({ status: 201, description: 'Student registered successfully' })\r\n  @ApiResponse({ status: 400, description: 'Bad request' })\r\n  @ApiResponse({ status: 409, description: 'Student already exists' })\r\n  async register(@Body() registerDto: RegisterStudentDto) {\r\n    const registerUseCase = makeRegisterUseCase()\r\n\r\n    const result = await registerUseCase.execute({\r\n      name: registerDto.name,\r\n      username: registerDto.username,\r\n      email: registerDto.email,\r\n      password: registerDto.password,\r\n      semester: registerDto.semester,\r\n      about: registerDto.about,\r\n      profileUrl: registerDto.profileUrl,\r\n      trailsIds: registerDto.trailsIds,\r\n    })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      if (error.statusCode === 409) {\r\n        throw new ConflictException(error.message)\r\n      }\r\n      throw new BadRequestException(error.message)\r\n    }\r\n\r\n    return { user_id: result.value.id.toString() }\r\n  }\r\n\r\n  @Post('sessions')\r\n  @HttpCode(HttpStatus.OK)\r\n  @ApiOperation({ summary: 'Login student' })\r\n  @ApiResponse({ status: 200, description: 'Login successful' })\r\n  @ApiResponse({ status: 401, description: 'Invalid credentials' })\r\n  async login(@Body() loginDto: LoginStudentDto) {\r\n    const loginUseCase = makeLoginUseCase()\r\n\r\n    const result = await loginUseCase.execute({\r\n      email: loginDto.email,\r\n      password: loginDto.password,\r\n    })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      throw new UnauthorizedException(error.message)\r\n    }\r\n\r\n    const token = this.jwtService.sign({\r\n      sub: result.value.id,\r\n      role: 'student',\r\n    })\r\n\r\n    return { token }\r\n  }\r\n\r\n  @Get('profiles/:username')\r\n  @ApiOperation({ summary: 'Get student profile by username' })\r\n  @ApiResponse({ status: 200, description: 'Profile retrieved successfully' })\r\n  @ApiResponse({ status: 404, description: 'Student not found' })\r\n  async getProfile(@Param('username') username: string) {\r\n    const getProfileUseCase = makeGetProfileUseCase()\r\n\r\n    const result = await getProfileUseCase.execute({ username })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      if (error.statusCode === 404) {\r\n        throw new NotFoundException(error.message)\r\n      }\r\n      throw new BadRequestException(error.message)\r\n    }\r\n\r\n    return StudentProfilePresenter.toHTTP(result.value)\r\n  }\r\n\r\n  @Put('profiles/:studentId')\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiBearerAuth()\r\n  @ApiOperation({ summary: 'Edit student profile' })\r\n  @ApiResponse({ status: 200, description: 'Profile updated successfully' })\r\n  @ApiResponse({ status: 403, description: 'Forbidden' })\r\n  @ApiResponse({ status: 404, description: 'Student not found' })\r\n  async editProfile(\r\n    @Param('studentId') studentId: string,\r\n    @Body() editDto: EditProfileDto,\r\n    @Request() req: any,\r\n  ) {\r\n    if (studentId !== req.user.userId) {\r\n      throw new ForbiddenException('Forbidden.')\r\n    }\r\n\r\n    const editProfileUseCase = makeEditProfileUseCase()\r\n\r\n    const result = await editProfileUseCase.execute({\r\n      studentId,\r\n      profileUrl: editDto.profileUrl,\r\n      semester: editDto.semester,\r\n      trailsIds: editDto.trailsIds,\r\n      about: editDto.about,\r\n    })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      if (error.statusCode === 404) {\r\n        throw new NotFoundException(error.message)\r\n      }\r\n      throw new BadRequestException(error.message)\r\n    }\r\n\r\n    return {\r\n      profile: StudentProfilePresenter.toHTTP(result.value),\r\n    }\r\n  }\r\n\r\n  @Get('students')\r\n  @ApiOperation({ summary: 'Fetch students' })\r\n  @ApiResponse({ status: 200, description: 'Students retrieved successfully' })\r\n  async fetchStudents(@Query() query: FetchStudentsDto) {\r\n    const fetchStudentsUseCase = makeFetchStudentsUseCase()\r\n\r\n    const result = await fetchStudentsUseCase.execute({\r\n      name: query.name,\r\n    })\r\n\r\n    return {\r\n      students: result.map(StudentPresenter.toHTTP),\r\n    }\r\n  }\r\n\r\n  @Get('students/:studentId')\r\n  @ApiOperation({ summary: 'Get student details' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Student details retrieved successfully',\r\n  })\r\n  @ApiResponse({ status: 404, description: 'Student not found' })\r\n  async getStudentDetails(@Param('studentId') studentId: string) {\r\n    const getStudentDetailsUseCase = makeGetStudentDetailsUseCase()\r\n\r\n    const result = await getStudentDetailsUseCase.execute({\r\n      username: studentId,\r\n    })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      if (error.statusCode === 404) {\r\n        throw new NotFoundException(error.message)\r\n      }\r\n      throw new BadRequestException(error.message)\r\n    }\r\n\r\n    return StudentProfilePresenter.toHTTP(result.value)\r\n  }\r\n\r\n  @Post('profile-images/:username')\r\n  @UseGuards(JwtAuthGuard)\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  @ApiBearerAuth()\r\n  @ApiConsumes('multipart/form-data')\r\n  @ApiOperation({ summary: 'Upload student profile image' })\r\n  @ApiBody({\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        file: {\r\n          type: 'string',\r\n          format: 'binary',\r\n        },\r\n      },\r\n    },\r\n  })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Profile image uploaded successfully',\r\n  })\r\n  @ApiResponse({ status: 404, description: 'Student not found' })\r\n  async uploadProfileImage(\r\n    @Param('username') username: string,\r\n    @UploadedFile() file: Express.Multer.File,\r\n  ) {\r\n    if (!file) {\r\n      throw new BadRequestException('File is required')\r\n    }\r\n\r\n    const uploadUseCase = makeUploadProfileImageUseCase()\r\n\r\n    const result = await uploadUseCase.execute({\r\n      username,\r\n      filename: file.originalname,\r\n      image: file.buffer,\r\n    })\r\n\r\n    if (result.isLeft()) {\r\n      const error = result.value\r\n      if (error.statusCode === 404) {\r\n        throw new NotFoundException(error.message)\r\n      }\r\n      throw new BadRequestException(error.message)\r\n    }\r\n\r\n    return { message: 'Profile image uploaded successfully' }\r\n  }\r\n\r\n  @Patch('token/refresh')\r\n  @HttpCode(HttpStatus.OK)\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiBearerAuth()\r\n  @ApiOperation({ summary: 'Refresh JWT token' })\r\n  @ApiResponse({ status: 200, description: 'Token refreshed successfully' })\r\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\r\n  async refreshToken(@Request() req: any) {\r\n    const token = this.jwtService.sign({\r\n      sub: req.user.userId,\r\n      role: 'student',\r\n    })\r\n\r\n    return { token }\r\n  }\r\n}\r\n"],"names":["StudentsController","register","registerDto","registerUseCase","makeRegisterUseCase","result","execute","name","username","email","password","semester","about","profileUrl","trailsIds","isLeft","error","value","statusCode","ConflictException","message","BadRequestException","user_id","id","toString","login","loginDto","loginUseCase","makeLoginUseCase","UnauthorizedException","token","jwtService","sign","sub","role","getProfile","getProfileUseCase","makeGetProfileUseCase","NotFoundException","StudentProfilePresenter","toHTTP","editProfile","studentId","editDto","req","user","userId","ForbiddenException","editProfileUseCase","makeEditProfileUseCase","profile","fetchStudents","query","fetchStudentsUseCase","makeFetchStudentsUseCase","students","map","StudentPresenter","getStudentDetails","getStudentDetailsUseCase","makeGetStudentDetailsUseCase","uploadProfileImage","file","uploadUseCase","makeUploadProfileImageUseCase","filename","originalname","image","buffer","refreshToken","summary","status","description","OK","schema","type","properties","format"],"mappings":";;;;+BAgDaA;;;eAAAA;;;wCAhD0B;0CACE;uCACH;8CACO;kCACZ;qCACG;+CACU;yBACb;gCACO;8BACX;wBAqBtB;qBACoB;iCACK;yBAQzB;;;;;;;;;;;;;;;AAQA,IAAA,AAAMA,qBAAN,MAAMA;IAGX,MAKMC,SAAS,AAAQC,WAA+B,EAAE;QACtD,MAAMC,kBAAkBC,IAAAA,wCAAmB;QAE3C,MAAMC,SAAS,MAAMF,gBAAgBG,OAAO,CAAC;YAC3CC,MAAML,YAAYK,IAAI;YACtBC,UAAUN,YAAYM,QAAQ;YAC9BC,OAAOP,YAAYO,KAAK;YACxBC,UAAUR,YAAYQ,QAAQ;YAC9BC,UAAUT,YAAYS,QAAQ;YAC9BC,OAAOV,YAAYU,KAAK;YACxBC,YAAYX,YAAYW,UAAU;YAClCC,WAAWZ,YAAYY,SAAS;QAClC;QAEA,IAAIT,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,IAAID,MAAME,UAAU,KAAK,KAAK;gBAC5B,MAAM,IAAIC,yBAAiB,CAACH,MAAMI,OAAO;YAC3C;YACA,MAAM,IAAIC,2BAAmB,CAACL,MAAMI,OAAO;QAC7C;QAEA,OAAO;YAAEE,SAASjB,OAAOY,KAAK,CAACM,EAAE,CAACC,QAAQ;QAAG;IAC/C;IAEA,MAKMC,MAAM,AAAQC,QAAyB,EAAE;QAC7C,MAAMC,eAAeC,IAAAA,kCAAgB;QAErC,MAAMvB,SAAS,MAAMsB,aAAarB,OAAO,CAAC;YACxCG,OAAOiB,SAASjB,KAAK;YACrBC,UAAUgB,SAAShB,QAAQ;QAC7B;QAEA,IAAIL,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,MAAM,IAAIY,6BAAqB,CAACb,MAAMI,OAAO;QAC/C;QAEA,MAAMU,QAAQ,IAAI,CAACC,UAAU,CAACC,IAAI,CAAC;YACjCC,KAAK5B,OAAOY,KAAK,CAACM,EAAE;YACpBW,MAAM;QACR;QAEA,OAAO;YAAEJ;QAAM;IACjB;IAEA,MAIMK,WAAW,AAAmB3B,QAAgB,EAAE;QACpD,MAAM4B,oBAAoBC,IAAAA,4CAAqB;QAE/C,MAAMhC,SAAS,MAAM+B,kBAAkB9B,OAAO,CAAC;YAAEE;QAAS;QAE1D,IAAIH,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,IAAID,MAAME,UAAU,KAAK,KAAK;gBAC5B,MAAM,IAAIoB,yBAAiB,CAACtB,MAAMI,OAAO;YAC3C;YACA,MAAM,IAAIC,2BAAmB,CAACL,MAAMI,OAAO;QAC7C;QAEA,OAAOmB,uCAAuB,CAACC,MAAM,CAACnC,OAAOY,KAAK;IACpD;IAEA,MAOMwB,YACJ,AAAoBC,SAAiB,EACrC,AAAQC,OAAuB,EAC/B,AAAWC,GAAQ,EACnB;QACA,IAAIF,cAAcE,IAAIC,IAAI,CAACC,MAAM,EAAE;YACjC,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,MAAMC,qBAAqBC,IAAAA,8CAAsB;QAEjD,MAAM5C,SAAS,MAAM2C,mBAAmB1C,OAAO,CAAC;YAC9CoC;YACA7B,YAAY8B,QAAQ9B,UAAU;YAC9BF,UAAUgC,QAAQhC,QAAQ;YAC1BG,WAAW6B,QAAQ7B,SAAS;YAC5BF,OAAO+B,QAAQ/B,KAAK;QACtB;QAEA,IAAIP,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,IAAID,MAAME,UAAU,KAAK,KAAK;gBAC5B,MAAM,IAAIoB,yBAAiB,CAACtB,MAAMI,OAAO;YAC3C;YACA,MAAM,IAAIC,2BAAmB,CAACL,MAAMI,OAAO;QAC7C;QAEA,OAAO;YACL8B,SAASX,uCAAuB,CAACC,MAAM,CAACnC,OAAOY,KAAK;QACtD;IACF;IAEA,MAGMkC,cAAc,AAASC,KAAuB,EAAE;QACpD,MAAMC,uBAAuBC,IAAAA,kDAAwB;QAErD,MAAMjD,SAAS,MAAMgD,qBAAqB/C,OAAO,CAAC;YAChDC,MAAM6C,MAAM7C,IAAI;QAClB;QAEA,OAAO;YACLgD,UAAUlD,OAAOmD,GAAG,CAACC,yBAAgB,CAACjB,MAAM;QAC9C;IACF;IAEA,MAOMkB,kBAAkB,AAAoBhB,SAAiB,EAAE;QAC7D,MAAMiB,2BAA2BC,IAAAA,0DAA4B;QAE7D,MAAMvD,SAAS,MAAMsD,yBAAyBrD,OAAO,CAAC;YACpDE,UAAUkC;QACZ;QAEA,IAAIrC,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,IAAID,MAAME,UAAU,KAAK,KAAK;gBAC5B,MAAM,IAAIoB,yBAAiB,CAACtB,MAAMI,OAAO;YAC3C;YACA,MAAM,IAAIC,2BAAmB,CAACL,MAAMI,OAAO;QAC7C;QAEA,OAAOmB,uCAAuB,CAACC,MAAM,CAACnC,OAAOY,KAAK;IACpD;IAEA,MAsBM4C,mBACJ,AAAmBrD,QAAgB,EACnC,AAAgBsD,IAAyB,EACzC;QACA,IAAI,CAACA,MAAM;YACT,MAAM,IAAIzC,2BAAmB,CAAC;QAChC;QAEA,MAAM0C,gBAAgBC,IAAAA,4DAA6B;QAEnD,MAAM3D,SAAS,MAAM0D,cAAczD,OAAO,CAAC;YACzCE;YACAyD,UAAUH,KAAKI,YAAY;YAC3BC,OAAOL,KAAKM,MAAM;QACpB;QAEA,IAAI/D,OAAOU,MAAM,IAAI;YACnB,MAAMC,QAAQX,OAAOY,KAAK;YAC1B,IAAID,MAAME,UAAU,KAAK,KAAK;gBAC5B,MAAM,IAAIoB,yBAAiB,CAACtB,MAAMI,OAAO;YAC3C;YACA,MAAM,IAAIC,2BAAmB,CAACL,MAAMI,OAAO;QAC7C;QAEA,OAAO;YAAEA,SAAS;QAAsC;IAC1D;IAEA,MAOMiD,aAAa,AAAWzB,GAAQ,EAAE;QACtC,MAAMd,QAAQ,IAAI,CAACC,UAAU,CAACC,IAAI,CAAC;YACjCC,KAAKW,IAAIC,IAAI,CAACC,MAAM;YACpBZ,MAAM;QACR;QAEA,OAAO;YAAEJ;QAAM;IACjB;IA5NA,YAAY,AAAQC,UAAsB,CAAE;aAAxBA,aAAAA;IAAyB;AA6N/C;;;;QA1NkBuC,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;;;;;;;;;6CA2BpBC;;QACLH,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;;;;;;;;;;QAuBzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;QAoBzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;;;QAkCzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;QAczBF,SAAS;;;QAEvBC,QAAQ;QACRC,aAAa;;;QAEAD,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;;;QAwBzBF,SAAS;;;QAEvBI,QAAQ;YACNC,MAAM;YACNC,YAAY;gBACVd,MAAM;oBACJa,MAAM;oBACNE,QAAQ;gBACV;YACF;QACF;;;QAGAN,QAAQ;QACRC,aAAa;;;QAEAD,QAAQ;QAAKC,aAAa;;;;;;;yDAGT,yCAAA,OAAO,wCAAP,OAAO;;;;;;6CA0BlBC;;;;QAGLH,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa"}