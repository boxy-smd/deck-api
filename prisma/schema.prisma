generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  name         String
  username     String     @unique
  email        String     @unique
  passwordHash String     @map("password_hash")
  about        String?
  profileUrl   String?    @map("profile_url")
  passwordResetToken   String?    @map("password_reset_token")
  passwordResetExpires DateTime?  @map("password_reset_expires")
  role         UserRole   @default(STUDENT)
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  projects        Project[]
  comments        Comment[]
  reports         Report[]  @relation("ReportAuthor")
  resolvedReports Report[]  @relation("ReportResolver")

  studentProfile StudentProfile?
  trail          StudentHasTrail[]

  @@map("users")
}

enum UserRole {
  STUDENT
  CURATOR
  MODERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

model StudentProfile {
  studentId String @id @map("student_id")
  semester  Int    @default(1)

  user User @relation(fields: [studentId], references: [id])

  @@map("student_profiles")
}

model StudentHasTrail {
  studentId String @map("student_id")
  trailId   String @map("trail_id")

  user  User  @relation(fields: [studentId], references: [id])
  trail Trail @relation(fields: [trailId], references: [id])

  @@id([studentId, trailId])
  @@map("student_has_trail")
}

model Trail {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  students StudentHasTrail[]
  projects ProjectTrail[]

  @@map("trails")
}

model Subject {
  id        String      @id @default(uuid())
  code      String      @unique
  name      String
  workload  Int
  semester  Int
  type      SubjectType
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  projects Project[]

  @@map("subjects")
}

enum SubjectType {
  OBLIGATORY
  ELECTIVE
  OPTIONAL
}

model Professor {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects ProjectProfessor[]

  @@map("professors")
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Project {
  id            String        @id @default(uuid())
  title         String
  description   String?
  content       String?
  semester      Int?
  publishedYear Int?          @map("published_year")
  status        ProjectStatus @default(DRAFT)
  allowComments Boolean       @default(false) @map("allow_comments")
  bannerUrl     String?       @map("banner_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime?     @updatedAt @map("updated_at")

  authorId String @map("author_id")
  author   User   @relation(fields: [authorId], references: [id])

  subjectId  String?            @map("subject_id")
  subject    Subject?           @relation(fields: [subjectId], references: [id])
  professors ProjectProfessor[]
  trails     ProjectTrail[]

  comments Comment[]

  @@map("projects")
}

model ProjectProfessor {
  projectId   String @map("project_id")
  professorId String @map("professor_id")

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  professor Professor @relation(fields: [professorId], references: [id])

  @@id([projectId, professorId])
  @@map("project_professors")
}

model ProjectTrail {
  projectId String @map("project_id")
  trailId   String @map("trail_id")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  trail   Trail   @relation(fields: [trailId], references: [id])

  @@id([projectId, trailId])
  @@map("project_trails")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  authorId  String  @map("author_id")
  author    User    @relation(fields: [authorId], references: [id])
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  reports Report[]

  @@map("comments")
}

model Report {
  id         String    @id @default(uuid())
  content    String
  isResolved Boolean   @map("is_resolved")
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  authorId   String  @map("author_id")
  author     User    @relation(fields: [authorId], references: [id], name: "ReportAuthor")
  commentId  String  @map("comment_id")
  comment    Comment @relation(fields: [commentId], references: [id])
  resolvedBy String? @map("resolved_by")
  resolver   User?   @relation(fields: [resolvedBy], references: [id], name: "ReportResolver")

  @@map("reports")
}
